# Виды вторичных индексов

## 1. Однопольные индексы (Single Field Index)

Индекс создаётся на одном поле. Используется для ускорения поиска, сортировки и операций сравнения.

```
db.collection.createIndex({ fieldName: 1 }); // 1 — сортировка по возрастанию
```

Особенности:
- Может использоваться для поиска по точным значениям или диапазонам.
- Полезен для простых фильтров и сортировок.

## 2. Составные индексы (Compound Index)

Индекс создаётся на нескольких полях. Используется для оптимизации запросов, включающих фильтрацию и сортировку по нескольким полям.

```
db.collection.createIndex({ field1: 1, field2: -1 });
```

Особенности:
- Порядок полей важен: индекс { field1: 1, field2: -1 } отличается от { field2: -1, field1: 1 }.
- Оптимален для запросов, которые используют левую часть индекса (например, фильтр только по field1).

Примеры использования:

### Эффективные запросы:
```
db.collection.find({ field1: "value1" });
db.collection.find({ field1: "value1", field2: "value2" });
db.collection.find({ field1: "value1" }).sort({ field2: -1 });
```
Эти запросы используют индекс, потому что они задействуют "левую часть" индекса (field1).

### Неэффективные запросы:
```
db.collection.find({ field2: "value2" });
```
MongoDB не сможет эффективно использовать составной индекс `{ field1: 1, field2: -1 }` для этого запроса, потому что пропущено первое поле индекса (field1).

## 3. Текстовые индексы (Text Index)

Используются для полнотекстового поиска в строковых полях.

```
db.collection.createIndex({ fieldName: "text" });
```
Особенности:
- Можно индексировать несколько полей одновременно.
- Используется с оператором $text для поиска по словам или фразам.
- Нельзя использовать точный поиск значений (это не замена стандартных индексов).

Примеры использования текстового индекса:

#### 1. Поиск по слову: Найти все документы, где в поле description встречается слово "garden":
```
db.collection.find({ $text: { $search: "garden" } });
```
#### 2. Поиск по нескольким словам: Найти все документы, содержащие слова "quiet" и "garden":
```
db.collection.find({ $text: { $search: "quiet garden" } });
```
(вернёт документы, которые содержат ОТДЕЛЬНО "quiet" И/ИЛИ "garden")

#### 3. Исключение слова: Найти документы, содержащие слово "garden", но не "quiet":
```
db.collection.find({ $text: { $search: "garden -quiet" } });
```
#### 4. Поиск точной фразы: Найти документы, где встречается точная фраза "small garden":
```
db.collection.find({ $text: { $search: "\"small garden\"" } });
```
(вернёт документы, которые содержат ЦЕЛИКОМ ФРАЗУ "small garden")

[Подробный пример](./theory_03__text_search_practice.md)

## 4. Хэш-индексы (Hashed Index)

Используются для равномерного распределения индекса по значению для больших БД, где данные распределены по нескольким серверам. Полезны при шардинге и поиске по точным значениям.

*Шардинг (sharding) — это способ горизонтального масштабирования базы данных, при котором данные распределяются между несколькими узлами (шардами). Это позволяет обрабатывать большие объёмы данных и запросов, распределяя нагрузку на несколько серверов.*
```
db.collection.createIndex({ fieldName: "hashed" });
```
Особенности:
- Подходит только для точного поиска ({ fieldName: value }).
- Нельзя использовать для диапазонных запросов или сортировки.

## 5. Уникальные индексы (Unique Index)

Обеспечивают уникальность значений в указанном поле или наборе полей.

```
db.collection.createIndex({ fieldName: 1 }, { unique: true });
```
Особенности:
- Запрещает добавление документов с повторяющимися значениями.
- Полезен для ключей, таких как email, username, и т. д.

## 6. Многоключевые индексы (Multikey Index)

Индексируются массивы. MongoDB создаёт отдельный индекс для каждого элемента массива.

```
db.collection.createIndex({ fieldArray: 1 });
```
Особенности:
- Поддерживает поиск и фильтрацию по элементам массива.
- Нельзя использовать с составными индексами, если несколько полей содержат массивы.
- Увеличение объёма индекса, так как индекс создаётся для каждого элемента массива.

## 7. Частичные индексы (Partial Index)

Индексируются только те документы, которые удовлетворяют указанному фильтру.

Пример 1: Индекс только для активных пользователей
```
db.users.createIndex(
    { username: 1 },
    { partialFilterExpression: { isActive: true } }
);
```
Индекс создаётся только для документов, где isActive: true.
    
Запрос: `db.users.find({ username: "John", isActive: true });` будет использовать этот индекс

Пример 2: Индекс для документов с ненулевым балансом
```
db.accounts.createIndex(
    { balance: 1 },
    { partialFilterExpression: { balance: { $gt: 0 } } }
);
```
Будут проиндексированы только те документы, где balance > 0.
    
Запрос: `db.accounts.find({ balance: { $gt: 100 } });` будет использовать этот индекс.

Особенности:
- Экономит пространство, так как индексируются только нужные документы.
- Ускоряет запросы с часто используемыми фильтрами.

## 8. Объединённые индексы (Wildcard Index)

Используются когда:
- Документы коллекции имеют **динамическую структуру** — поля различаются от документа к документу.
- Документ содержит большое количество полей и заранее определить, какие именно поля будут использоваться в запросах, сложно или невозможно.

```
db.collection.createIndex({ "$**": 1 });
```
Особенности:
- Полезны для коллекций с гибкой схемой.
- Индексируются все поля или только указанный поднабор.

## 9. Геопространственные индексы (Geospatial Index)

Используются для запросов с географическими координатами.

Индекс типа 2d (плоских 2D-координат без учёта кривизны земли):
```
db.collection.createIndex({ location: "2d" });
```
Пример `2D` инедкса (просто массив из 2-х значений):
``` 
{
    location: [longitude, latitude]  // X, Y
}
```
Индекс типа 2DSphere (с учётом сферичности земной поверхности):
```
db.collection.createIndex({ location: "2dsphere" });
```
Особенности:
- Поддерживают запросы, такие как поиск ближайших точек, пересечения с геометрическими объектами и т. д.

Пример `2dsphere` индекса:
```
{
  "location": {
    "type": "Point",
    "coordinates": [longitude, latitude]
  }
}
```

## 10. врЕменные индексы (TTL Index)

Автоматически удаляют документы через указанное время.

```
db.collection.createIndex({ createdAt: 1 }, { expireAfterSeconds: 3600 });
```
Особенности:
- Полезны для хранения временных данных, например, сессий, логов.

| **Тип индекса**        | **Особенности**                                                 |
|------------------------|-----------------------------------------------------------------|
| **Однопольный**         | Для простого поиска и сортировки.                              |
| **Составной**           | Для фильтрации и сортировки по нескольким полям.               |
| **Текстовый**           | Полнотекстовый поиск.                                          |
| **Хэш-индекс**          | Для точного поиска и шардинга.                                 |
| **Уникальный**          | Обеспечивает уникальность значений.                            |
| **Многоключевой**       | Индексирует элементы массива.                                  |
| **Частичный**           | Индексирует только документы, удовлетворяющие условию.         |
| **Wildcard**            | Индексирует все поля или поднабор полей.                       |
| **Геопространственный** | Поддерживает географические запросы.                            |
| **TTL**                 | Автоматически удаляет документы через заданное время.          |
