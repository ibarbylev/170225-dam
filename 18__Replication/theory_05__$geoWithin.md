# Геопространственный поиск в MongoDB

В MongoDB оператор $geoWithin используется для выполнения геопространственных запросов, которые ищут документы с координатами, находящимися внутри определенной геометрической формы или региона. Этот оператор может работать с различными геометрическими объектами, такими как:

- Круг (или сфера в случае `$centerSphere`): Находит точки внутри круга.
- Прямоугольник (`$box`): Находит точки внутри прямоугольной области.
- Многоугольник (`$polygon`): Находит точки внутри определенного многоугольника.


Вот как работает $geoWithin с различными геометрическими объектами:

## 1. Сфера или Круг ($centerSphere)

```
{ $geoWithin: { $centerSphere: [ [ <x>, <y> ], <radius> ] } }
```
Где <x> и <y> — это координаты центра круга в формате [долгота, широта], 
а <radius> — радиус круга в радианах.
радиус(радианы) = радиус(км) / 6378.1

Пример:
```
    db.places.find({
      loc: {
        $geoWithin: { 
          $centerSphere: [ [ -157.8583, 21.3069 ], 0.0847 ] 
        }
      }
    })
```
Этот запрос найдёт все документы, где поле `loc` находится внутри круга с радиусом 0.0847 радиана (~540 км) вокруг точки с координатами Гавайских островов.


## 2. Прямоугольник ($box)
```
{ $geoWithin: { $box: [ [ <x1>, <y1> ], [ <x2>, <y2> ] ] } }
```
Определяет прямоугольник по двум противоположным углам.
Пример:
```
    db.places.find({
      loc: {
        $geoWithin: { 
          $box: [ [ 0, 0 ], [ 10, 10 ] ] 
        }
      }
    });
```
Это найдет все документы, где loc находится внутри прямоугольника от (0,0) до (10,10).


## 3. Многоугольник ($polygon)

```
{ $geoWithin: { $polygon: [ [ <x1>, <y1> ], [ <x2>, <y2> ], ... ] } }
```
Где каждый массив представляет собой координаты вершины многоугольника.
Пример:
```
    db.places.find({
      loc: {
        $geoWithin: { 
          $polygon: [
            [ 0, 0 ],
            [ 3, 6 ],
            [ 6, 0 ],
            [ 0, 0 ]
          ]
        }
      }
    });
```
Этот запрос найдёт все документы, где `loc` находится внутри описанного многоугольника.


### Общие замечания:
- **Тип индекса:** 
    - Для использования $geoWithin необходимо, чтобы на поле, по которому выполняется запрос, был создан индекс типа 2dsphere или 2d. 2dsphere используется для данных в формате GeoJSON или для координат в формате [долгота, широта], а 2d для плоских координат.
- **Геометрический порядок:** 
    - Для `$polygon` и `$box` важен порядок точек; для многоугольников точки должны быть указаны по часовой стрелке, чтобы область была правильно определена.
- **Производительность:** 
    - Использование $geoWithin с правильным индексом может значительно улучшить производительность геопространственных запросов.


Таким образом, `$geoWithin` в MongoDB позволяет выполнять мощные геопространственные запросы для поиска документов внутри определенных геометрических фигур на земной поверхности или плоском пространстве.