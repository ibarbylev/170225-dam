# Операции со строками в MongoDB


В MongoDB для работы со строками используются различные операторы в рамках агрегации и запросов. Эти операторы позволяют манипулировать строковыми данными, извлекать подстроки, преобразовывать регистры и т. д. Вот основные операторы и методы для работы с строками в MongoDB.

## 1. $concat — объединение строк

Оператор `$concat` используется для объединения двух или более строк в одну строку.

*Пример: Объединим имя и фамилию в одно поле full_name:*

```
db.collection.aggregate([
  {
    $project: {
      full_name: { $concat: ["$first_name", " ", "$last_name"] }  
    }
  }
]);
```

## 2. $substr — извлечение подстроки

Оператор `$substr` используется для извлечения части строки. Он принимает три аргумента: строку, начальную позицию и длину подстроки.

*Пример: Извлечем первые 5 символов из строки name:*

```
db.collection.aggregate([
  {
    $project: {
      short_name: { $substr: ["$name", 0, 5] }  // Извлечение первых 5 символов из name
    }
  }
]);
```

## 3. $toUpper — преобразование в верхний регистр

Оператор `$toUpper` преобразует строку в верхний регистр.

*Пример: Преобразуем строку name в верхний регистр:*

```
db.collection.aggregate([
  {
    $project: {
      upper_name: { $toUpper: "$name" }  // Преобразование name в верхний регистр
    }
  }
]);
```

## 4. $toLower — преобразование в нижний регистр

Оператор `$toLower` преобразует строку в нижний регистр.

*Пример: Преобразуем строку name в нижний регистр:*

```
db.collection.aggregate([
  {
    $project: {
      lower_name: { $toLower: "$name" }  // Преобразование name в нижний регистр
    }
  }
]);
```

## 5. $trim — обрезка пробелов

Оператор `$trim` удаляет пробелы в начале и в конце строки.

*Пример: Обрежем пробелы в строке name:*

```
db.collection.aggregate([
  {
    $project: {
      trimmed_name: { $trim: { input: "$name" } }  // Удаление пробелов с обеих сторон строки
    }
  }
]);
```

## 6. $split — разделение строки

Оператор `$split` разделяет строку на **массив строк** по указанному разделителю.

*Пример: Разделим строку address по пробелам:*

```
db.collection.aggregate([
  {
    $project: {
      address_parts: { $split: ["$address", " "] }  // Разделение строки address по пробелам
    }
  }
]);
```
Результат запроса будет следующим (в формате JSON):

```
{
  "_id": ObjectId("..."),
  "address_parts": ["123", "Main", "St", "New", "York"]
}
```

## 7. $indexOfBytes — поиск подстроки

Оператор `$indexOfBytes` находит позицию первого вхождения подстроки в строке (считается с нуля). Возвращает -1, если подстрока не найдена.

*Пример: Ищем индекс первого вхождения подстроки "New" в строке address:*

```
db.collection.aggregate([
  {
    $project: {
      index: { $indexOfBytes: ["$address", "New"] }  // Ищем индекс первого вхождения "New"
    }
  }
]);
```

## 8. $replaceOne — замена первой подстроки

Оператор `$replaceOne` заменяет первое вхождение подстроки на другую строку.

*Пример: Заменим первое вхождение "Street" на "St." в строке address:*

```
db.collection.aggregate([
  {
    $project: {
      updated_address: { $replaceOne: { input: "$address", find: "Street", replacement: "St." } } 
    }
  }
]);
```

## 9. $replaceAll — замена всех подстрок

Оператор `$replaceAll` заменяет все вхождения подстроки на другую строку.

*Пример: Заменим все вхождения "Street" на "St." в строке address:*

```
db.collection.aggregate([
  {
    $project: {
      updated_address: { $replaceAll: { input: "$address", find: "Street", replacement: "St." } }  // Заменить все "Street" на "St."
    }
  }
]);
```
## 10. $concatArrays — объединение массивов строк

Оператор `$concatArrays` объединяет два или более массива строк в один.

*Пример: Объединим массивы name_parts и address_parts в один массив:*

```
db.collection.aggregate([
  {
    $project: {
      full_data: { $concatArrays: ["$name_parts", "$address_parts"] }  // Объединение массивов name_parts и address_parts
    }
  }
]);
```

## 11. $strLenBytes — длина строки в байтах

Оператор `$strLenBytes` возвращает длину строки в байтах.

*Пример: Получим длину строки name в байтах:*

```
db.collection.aggregate([
  {
    $project: {
      name_length: { $strLenBytes: "$name" }  // Длина строки name в байтах
    }
  }
]);
```

## 12. $strLenCP — длина строки в кодовых точках Unicode

Оператор `$strLenCP` возвращает количество кодовых точек Unicode в строке.

*Пример: Получим длину строки name в кодовых точках:*

```
db.collection.aggregate([
  {
    $project: {
      name_length_cp: { $strLenCP: "$name" }  // Длина строки name в кодовых точках
    }
  }
]);
```

## 13. $regex — регулярные выражения

Оператор `$regex` используется для поиска строк, соответствующих регулярному выражению.

*Пример: Найдем все документы, где address содержит "New":*

```
db.collection.aggregate([
  {
    $match: {
      address: { $regex: /New/ }  // Проверка на наличие "New" в строке address
    }
  }
]);
```

## 14. $toString — преобразование в строку

Оператор `$toString` преобразует любое значение в строку.

*Пример: Преобразуем числовое поле price в строку:*

```
db.collection.aggregate([
  {
    $project: {
      price_as_string: { $toString: "$price" }  // Преобразование price в строку
    }
  }
]);
```

Помимо этого, в MongoDB существует операторы, который позволяет преобразовать строку обратно в число — это `$toDouble`, `$toInt`, и `$toDecimal`. Эти операторы выполняют преобразование строки в числовой тип данных.

**ВНИМАНИЕ: перед началом преобразований необходимо убедиться, что стока содержит числа нужного формата. Сделать это можно с помощью регулярных выражений**

## 15. $toDouble — преобразование строки в число с плавающей запятой (тип double)

Оператор `$toDouble` преобразует строку в число с плавающей запятой. Если строка не является числом, то будет возвращено null.

*Пример: Преобразуем строку "123.45" в число с плавающей запятой:*

```
db.collection.aggregate([
  {
    $project: {
      number_value: { $toDouble: "$string_field" }  // Преобразование строки в число с плавающей запятой
    }
  }
]);
```

Результат:
```
{
  "_id": ObjectId("..."),
  "number_value": 123.45
}
```

## 16. $toInt — преобразование строки в целое число (тип int)

Оператор `$toInt` преобразует строку в целое число. Если строка не может быть преобразована в целое число, будет возвращено null.

*Пример: Преобразуем строку "123" в целое число:*

```
db.collection.aggregate([
  {
    $project: {
      int_value: { $toInt: "$string_field" }  // Преобразование строки в целое число
    }
  }
]);
```

Результат:
```
{
  "_id": ObjectId("..."),
  "int_value": 123
}
```

## 17. $toDecimal — преобразование строки в число с высокой точностью (тип decimal128)

Оператор `$toDecimal` преобразует строку в decimal128, который используется для работы с числами с высокой точностью, что полезно для финансовых вычислений.

*Пример: Преобразуем строку "123.456789" в decimal128:*

```
db.collection.aggregate([
  {
    $project: {
      decimal_value: { $toDecimal: "$string_field" }  // Преобразование строки в decimal128
    }
  }
]);
```

Результат:
```
{
  "_id": ObjectId("..."),
  "decimal_value": NumberDecimal("123.456789")
}
```

## Пример комбинирования строковых операций:

Можно комбинировать несколько строковых операций в одном запросе. Например, для создания строки с обработанными значениями:

```
db.collection.aggregate([
  {
    $project: {
      full_address: {
        $concat: [
          { $toUpper: "$city" },  // Преобразование города в верхний регистр
          ", ",
          "$street"                // Добавление улицы
        ]
      }
    }
  }
]);
```
Эти операторы и методы позволяют гибко работать со строками в MongoDB, выполнять фильтрацию, трансформацию и агрегацию данных, а также применять сложные строковые манипуляции при необходимости.
